---
layout: post
title: 'TIL #40'
category:
  - Today I Learned
tags:
  - Redis
  - Node.js
  - JWT
  - Docker Compose
date: '2023-07-28T22:45:00+09:00'
---

## Redis ì„¤ì¹˜ë¶€í„° ì ìš©ê¹Œì§€

### Connect

```javascript
import { createClient } from 'redis';

const client = createClient();
// const client = createClient({ legacyMode: true });

client.on('connect', () => console.log('Redis Client Connect'));
client.on('error', (err) => console.log('Redis Client Error', err));

await client.connect();
```

- `legacyMode: true`: ì˜›ë‚  ë¬¸ë²•ìœ¼ë¡œ ì‚¬ìš©í•˜ê³  ì‹¶ë‹¤ë©´,Â `createClient({ Â legacyMode: true })`Â ë¡œ ë ˆê±°ì‹œ ëª¨ë“œë¥¼ ì„¤ì •í•´ì£¼ë©´ í˜¸í™˜ì„± ë¬¸ì œì—†ì´ ì‚¬ìš©ì´ ê°€ëŠ¥í•˜ë‹¤. í˜„ì¬ ìµœì‹  ë¬¸ë²•ì€ v4ì´ë‹¤.

ë¡œì»¬ì—ì„œ redisë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš°,`redis-server`ë¥¼ ì´ìš©í•´ ì„œë²„ë¥¼ ë¡œì»¬ì—ì„œ ì¼œì¤˜ì•¼ í•œë‹¤. ê·¸ë˜ì•¼ Redisì™€ ì—°ê²°ì´ ëœë‹¤.

### Methods

```javascript
// ì €ì¥
await client.set('key', 'value');

// ê°€ì ¸ì˜¤ê¸°
await client.get('key');

// ì‚­ì œ
await client.del('key');

// ë§Œë£Œì‹œê°„ ë“±ë¡(Seconds: Number)
await client.expire('key', seconds);
```

redis-cliì—ì„œ ì €ì¥ëœ keyì™€ valueë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ì €ì¥ëœ í‚¤ë¥¼ í™•ì¸í• ë•ŒëŠ” `get key`ë¡œ ê²€ìƒ‰ì´ ê°€ëŠ¥í•˜ë‹¤. keyì˜ ë§Œë£Œì‹œê°„ì„ í™•ì¸í•  ë•ŒëŠ” `ttl key`ë¡œ ê²€ìƒ‰í•´ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

## AccessToken: blacklist

```javascript
app.post('/logout', authenticateToken, async (request, response) => {
  const { userId, token, tokenExp } = request;

  const token_key = `bl_${token}`;
  await redisClient.set(token_key, token);
  redisClient.expireAt(token_key, tokenExp);

  return response.status(200).send('Token invalidated');
});
```

ë¡œê·¸ì•„ì›ƒ, íšŒì›íƒˆí‡´ ì‹œ Access Tokenì€ Redisì— ë‚¨ì€ ë§Œë£Œ ì‹œê°„ë§Œí¼ ì €ì¥í•´ì¤˜ì•¼ í•œë‹¤. ëˆ„êµ°ê°€ ë§Œë£Œê¸°ê°„ì´ ë‚¨ì€ Access Tokenì„ íƒˆì·¨í•  ê°€ëŠ¥ì„±ì´ ìˆê¸° ë•Œë¬¸ì´ë‹¤. ì´ ë§Œë£Œê¸°ê°„ì´ ë‚¨ì€ Access Token ëª©ë¡ì„ ë¸”ë™ë¦¬ìŠ¤íŠ¸ë¼ê³  ì¹­í•˜ê² ë‹¤. Redisì— í† í°ì„ ì €ì¥í• ë•Œ ì•ì— `bl_`ì„ ë¶™ì—¬ ë¸”ë™ë¦¬ìŠ¤íŠ¸ì„ì„ ëª…ì‹œí•œë‹¤. ê·¸ë¦¬ê³ , Access Token ìš”ì²­ì´ ì˜¬ë•Œë§ˆë‹¤ ì´ ë¸”ë™ë¦¬ìŠ¤íŠ¸ì— ì†í•´ìˆëŠ” í† í°ì¸ì§€ í™•ì¸ì„ í•´ì¤€ë‹¤.

Access Tokenê³¼ ë‹¬ë¦¬ Refresh Tokenì€ Redisì—ì„œ ì‚­ì œë§Œ í•´ì£¼ë©´ ëœë‹¤. Refresh Tokenì„ ê²€ì¦í• ë•Œ Redisë‚´ì—ì„œ í‚¤ê°’ìœ¼ë¡œ ê²€ìƒ‰í•˜ê¸° ë•Œë¬¸ì— ë§Œë£Œê¸°ê°„ì´ ë‚¨ì•˜ë‹¤ê³  í•´ì„œ ë¸”ë™ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€í•˜ì§€ ì•Šì•„ë„ ëœë‹¤.

## JWT: Decoding

```javascript
// ë§Œë£Œëœ í† í°ì´ë©´ verify í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤.
const payload = jwt.verify(token, JWT_SECRET);

// ë§Œë£Œëì„ë•Œ decodeë¥¼ ì‚¬ìš©í•˜ë©´ í˜ì´ë¡œë“œë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
const payload = jwt.decode(token);
```

## Docker Compose

Docker Composeë¥¼ ì‚¬ìš©í•˜ë©´ ì—¬ëŸ¬ê°œì˜ ì„œë¹„ìŠ¤ë¥¼ í•˜ë‚˜ì˜ íŒŒì¼ë¡œ ê´€ë¦¬í•´ ë³µì¡í•œ Docker ì»¨í…Œì´ë„ˆ ë° ë„¤íŠ¸ì›Œí¬ë¥¼ êµ¬ì„±í•˜ê¸°ì— í¸ë¦¬í•˜ë‹¤. `docker-compose up`ê³¼ ê°™ì´ í•œë²ˆì˜ ëª…ë ¹ì–´ë¡œ docker-compose.ymlì— ì‘ì„±ëœ ì—¬ëŸ¬ê°œì˜ ì„œë¹„ìŠ¤ë“¤ì„ í•œë²ˆì— ë¹Œë“œ ë° ì‹¤í–‰ ì‹œí‚¬ ìˆ˜ ìˆì–´ ì‘ì—…í•˜ê¸°ì—ë„ í¸í•˜ë‹¤.

```yaml
version: '3'
services:
  nginx:
    image: nginx:latest
    ports:
      - '80:80'
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - node

  node:
    image: node:latest
    working_dir: /app
    volumes:
      - ./app:/app

  redis:
    image: redis:latest
    ports:
      - '6379:6379'
```

GPTê°€ ë§Œë“¤ì–´ì¤€ docker-compose.yml ì˜ˆì‹œì´ë‹¤. í˜„ì¬ ì§„í–‰ì¤‘ì¸ í”„ë¡œì íŠ¸ì—ì„œëŠ” Nginx, Node.js, Redisë¥¼ ì“°ê¸°ì— ì´ì™€ ê´€ë ¨ëœ ì„œë¹„ìŠ¤ë¥¼ ìƒì„±í•´ì¤˜ì•¼ í•œë‹¤.

### ë‹¨ê³„

1. ê° ì„œë¹„ìŠ¤ì™€ ê´€ë ¨ëœ ì„¤ì •ì„ docker-compose.yml ì‘ì„±í•œë‹¤. í•„ìš”í•œ ê²½ìš° ì„œë¹„ìŠ¤ë³„ Dockerfileì„ ì‘ì„±í•œë‹¤.
2. `docker-compose up` ì»¤ë§¨ë“œë¥¼ ì‹¤í–‰í•˜ì—¬ docker-compose.ymlìœ¼ë¡œ ì •ì˜í•œ ì„œë¹„ìŠ¤ë“¤ì„ ë¹Œë“œí•˜ê³  ì‹¤í–‰í•œë‹¤.

ê°œë°œë‹¨ê³„ì—ì„œëŠ” ì´ì „ì— ìºì‹œëœ ë°ì´í„°ì™€ ë°”ë€ ë¶€ë¶„ì´ ë§ê¸° ë•Œë¬¸ì— ë‚˜ëŠ” ì£¼ë¡œ `docker-compose build --no-cache`ë¥¼ ì´ìš©í•´ ë¹Œë“œë¥¼ í•´ì£¼ì—ˆë‹¤.

---

### Reference

- [\[REDIS\] ğŸ“š Node.js ì—ì„œ redis ëª¨ë“ˆ ì‚¬ìš©ë²• \(ìºì‹± & ì„¸ì…˜ ìŠ¤í† ì–´\)](https://inpa.tistory.com/entry/REDIS-NODE-%F0%9F%93%9A-%EB%85%B8%EB%93%9Cexpress%EC%97%90%EC%84%9C-redis-%EC%82%AC%EC%9A%A9%EB%B2%95-%EC%BA%90%EC%8B%B1-%EC%84%B8%EC%85%98-%EC%8A%A4%ED%86%A0%EC%96%B4)
- [Node.js guide](https://redis.io/docs/clients/nodejs/)
- [Revoking Access to JWT tokens with a Blacklist/Deny List](https://supertokens.com/blog/revoking-access-with-a-jwt-blacklist)
- [\[redis\] EXPIREì™€ EXPIREAT ì»¤ë§¨ë“œ](https://knight76.tistory.com/entry/redis-EXPIRE%EC%99%80-EXPIREAT-%EC%BB%A4%EB%A7%A8%EB%93%9C)
- [Dockerizing a NodeJS , Express, Redis with Nginx Proxy using Docker Compose](https://collabnix.com/dockerizing-a-nodejs-express-redis-with-nginx-proxy-using-docker-compose/)
- [\[Docker\] docker compose ì‚¬ìš©ë²•](https://engineer-mole.tistory.com/221)
